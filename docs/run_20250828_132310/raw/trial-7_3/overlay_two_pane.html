<!doctype html>
<meta charset="utf-8"/>
<title>Overlay + Logit Lens</title>
<style>
  :root { --hl: 255,200,0; }
  body {margin:0; font-family: system-ui, sans-serif;}
  .row {display:flex; height: 100vh;}
  .left {flex: 1 1 46%; padding: 12px; box-sizing: border-box; overflow:auto;}
  .right{flex: 1 1 54%; border-left: 1px solid #ddd;}
  .wrap {position: relative; display: inline-block; line-height: 0;}
  img {display:block; max-width: 100%; height: auto;}
  canvas#heat {position:absolute; top:0; left:0; pointer-events:none;}
  #alpha { width: 240px; vertical-align: middle; }
  #info { margin-left: 8px; }
  iframe {width:100%; height:100%; border:0;}
  .hint {font-size:12px; opacity:.8; margin-top:6px;}
  .btn {margin-left:10px; font-size:12px; padding:3px 8px; cursor:pointer;}
</style>
<div class="row">
  <div class="left">
    <div>
      <label>Heatmap opacity:
        <input id="alpha" type="range" min="0" max="1" value="0.6" step="0.01">
      </label>
      <button id="clear" class="btn">Clear selection (Esc)</button>
      <span id="info"></span>
      <div class="hint">Hover = temporary highlight â€¢ Click = lock to a row</div>
    </div>
    <div class="wrap">
      <img id="img" src="data:image/png;base64,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" />
      <canvas id="heat"></canvas>
    </div>
  </div>
  <div class="right">
    <iframe id="lens" src="report_ll.html"></iframe>
  </div>
</div>
<script>
const DATA = {"attn_map": [[0.03752987363751137, 0.010720854555428035, 0.008295607760979592, 0.01110580824915833, 0.0069137814576814925, 0.00867110105587959, 0.008084230889170693, 0.008429911558546591, 0.010635631022469344], [0.012409571941521388, 0.004833042618321845, 0.004300478313459242, 0.0049839211554989675, 0.00758071848776243, 0.005958923241614793, 0.005909197763831888, 0.013607714551940661, 0.0034029874170677763], [0.014848538171228751, 0.013413325985649897, 0.007180570495877521, 0.016727591555400115, 0.004062304636925762, 0.006901949192273741, 0.0033612506226008134, 0.016867835091031038, 0.008231702071309662], [0.01771573836494227, 0.00669660333258761, 0.0076909655907990235, 0.008964294735085296, 0.003988545755234365, 0.0066783938431097456, 0.006895042578662323, 0.005005882953009794, 0.003168566363305393], [0.008215887109554896, 0.010244092377500529, 0.010709205467614245, 0.00696458900516892, 0.005180035745716319, 0.00678580893241705, 0.007350786544004588, 0.005435014550173974, 0.0074467835632884205], [0.03046035408586455, 0.005853142272698962, 0.0052992377781400845, 0.009029742641611585, 0.032290420367915254, 0.027958195992575055, 0.026130710563222744, 0.009365386941372057, 0.005018337455708366], [0.014428061872748223, 0.01146456565852362, 0.013434988781933471, 0.047636578413208445, 0.01178863011285977, 0.013846210520323308, 0.009618201606420665, 0.04932748259985648, 0.004426010988709297], [0.03733723375629283, 0.01639820928555273, 0.013472651605994573, 0.03433402766118391, 0.007407233569376149, 0.028803821821349017, 0.0065409823212081155, 0.01701645695578773, 0.021549170781407202], [0.04376613027428581, 0.005870223740704746, 0.00822217180061363, 0.00389356187800372, 0.006967811923660578, 0.003572052782577118, 0.006957383390330248, 0.005151558868832708, 0.00525839861683115]], "grid_hw": [9, 9]};                  // {attn_map, grid_hw}
const ATT  = DATA.attn_map;
const GRID = DATA.grid_hw;              // [H, W], row-major

const alphaInput = document.getElementById('alpha');
const img  = document.getElementById('img');
const heat = document.getElementById('heat');
const info = document.getElementById('info');
const lens = document.getElementById('lens');
const clearBtn = document.getElementById('clear');

let selectedIdx = null;   // click-to-lock selection (null = none)

function drawOverlay() {
  if (!img.naturalWidth || !img.naturalHeight) return;
  const H = GRID[0], W = GRID[1];
  const w = img.clientWidth, h = img.clientHeight;
  heat.width = w; heat.height = h;

  const ctx = heat.getContext('2d');
  ctx.clearRect(0,0,w,h);
  ctx.globalAlpha = parseFloat(alphaInput.value || "0.6");
  const cellW = w / W, cellH = h / H;

  let maxv = 0; for (let r=0;r<H;r++) for (let c=0;c<W;c++) if (ATT[r][c]>maxv) maxv = ATT[r][c];
  if (maxv <= 0) maxv = 1;

  for (let r=0; r<H; r++) for (let c=0; c<W; c++) {
    const v = ATT[r][c] / maxv;
    const x = Math.round(c*cellW), y = Math.round(r*cellH);
    const cw = Math.ceil(cellW),   ch = Math.ceil(cellH);
    ctx.fillStyle = `rgba(255, 0, 0, ${v})`;
    ctx.fillRect(x, y, cw, ch);
  }
  ctx.globalAlpha = 1;
}

function rcToIndex(r,c){ return r*GRID[1] + c; }

// ----- highlight inside the iframe -----
function ensureIframeStyles(doc) {
  if (doc.getElementById('_hl_style')) return;
  const st = doc.createElement('style');
  st.id = '_hl_style';
  st.textContent = `
    /* keep rows visible but hide preview images in the lens pane */
    img { display: none !important; }
    ._patch-highlight { outline: 3px solid rgb(255,200,0); background: rgba(255,200,0,.15) !important; }
    tr._patch-highlight > td { background: rgba(255,200,0,.15) !important; }
  `;
  doc.head.appendChild(st);
}

function clearHighlight(doc) {
  if (!doc) return;
  doc.querySelectorAll('._patch-highlight').forEach(el => el.classList.remove('_patch-highlight'));
}

function highlightRow(idx) {
  const doc = lens.contentDocument;
  if (!doc) return;
  ensureIframeStyles(doc);
  clearHighlight(doc);

  // 1) data attribute exact match (0- or 1-based)
  let row = doc.querySelector(`[data-patch-index="${idx}"]`) ||
            doc.querySelector(`[data-patch-index="${idx+1}"]`);

  // 2) fallback: first column equals idx (or idx+1)
  if (!row) {
    const tables = Array.from(doc.querySelectorAll('table'));
    for (const tb of tables) {
      for (const tr of Array.from(tb.querySelectorAll('tr'))) {
        const first = tr.querySelector('td,th');
        if (!first) continue;
        const t = (first.textContent || '').trim();
        if (t === String(idx) || t === String(idx+1)) { row = tr; break; }
      }
      if (row) break;
    }
  }

  if (!row) return;
  row.classList.add('_patch-highlight');
  if (row.scrollIntoView) row.scrollIntoView({block:'center', inline:'nearest', behavior:'smooth'});
}

// events
alphaInput.addEventListener('input', drawOverlay);
window.addEventListener('resize', drawOverlay);
img.addEventListener('load', drawOverlay);

// hover = temporary (unless a selection exists)
img.addEventListener('mousemove', ev => {
  const rect = img.getBoundingClientRect();
  const H = GRID[0], W = GRID[1];
  const r = Math.min(H-1, Math.max(0, Math.floor((ev.clientY - rect.top) / (img.clientHeight / H))));
  const c = Math.min(W-1, Math.max(0, Math.floor((ev.clientX - rect.left) / (img.clientWidth  / W))));
  const w = ATT[r][c];
  info.textContent = `r=${r+1}, c=${c+1}, weight=${w.toFixed(4)}`;
  if (selectedIdx === null) highlightRow(rcToIndex(r,c));
});

// click = lock
img.addEventListener('click', ev => {
  const rect = img.getBoundingClientRect();
  const H = GRID[0], W = GRID[1];
  const r = Math.min(H-1, Math.max(0, Math.floor((ev.clientY - rect.top) / (img.clientHeight / H))));
  const c = Math.min(W-1, Math.max(0, Math.floor((ev.clientX - rect.left) / (img.clientWidth  / W))));
  selectedIdx = rcToIndex(r,c);
  highlightRow(selectedIdx);
});

// optional: clear selection
function clearSelection(){
  selectedIdx = null;
  // refresh current hover highlight (or none)
  clearHighlight(lens.contentDocument);
}
clearBtn.addEventListener('click', clearSelection);
window.addEventListener('keydown', e => { if (e.key === 'Escape') clearSelection(); });

// re-apply highlight after iframe loads (so the lock persists on reload)
lens.addEventListener('load', () => {
  drawOverlay();
  if (selectedIdx !== null) highlightRow(selectedIdx);
});
</script>
